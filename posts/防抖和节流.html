<!doctype html><html class="" data-reactroot=""><head><link rel="icon" type="image/png" href="/favicon.png"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="欢迎来到我的博客。"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">防抖和节流 · jianyuns&#x27;Blog</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">jianyuns&#x27;Blog</a><aside class="hide_on_mobile"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">jianyuns&#x27;Blog</a></h1><p class="description">欢迎来到我的博客。</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/jianyun2020" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:sujianyun2020@163.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li></ul></nav></aside><section class="main"><h1>防抖和节流</h1><div class="main_post_meta"><time dateTime="Mon Jan 25 2021 10:51:54 GMT+0000 (UTC)">2021-01-26</time> · <!-- -->jianyun2020</div><article><h2 id="%E9%98%B2%E6%8A%96">防抖<a class="anchor" href="#%E9%98%B2%E6%8A%96">§</a></h2>
<h3 id="%E5%AE%9A%E4%B9%89%E6%8C%87%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%9C%A8%E8%A7%84%E5%AE%9A%E6%97%B6%E9%97%B4%E5%86%85%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E5%8F%AA%E8%83%BD%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E5%A6%82%E6%9E%9C%E5%9C%A8%E8%A7%84%E5%AE%9A%E6%97%B6%E9%97%B4%E5%86%85%E5%8F%88%E8%A7%A6%E5%8F%91%E4%BA%86%E8%AF%A5%E4%BA%8B%E4%BB%B6%E5%88%99%E4%BC%9A%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B%E7%AE%97%E8%A7%84%E5%AE%9A%E6%97%B6%E9%97%B4%E7%AE%80%E8%80%8C%E8%A8%80%E4%B9%8B%E5%B0%B1%E6%98%AF%E5%BB%B6%E6%97%B6%E6%89%A7%E8%A1%8C">定义：指触发事件后在<strong>规定时间内</strong>回调函数<strong>只能执行一次</strong>，如果在规定时间内又触发了该事件，则会重新开始算规定时间。简而言之就是<strong>延时执行</strong>。<a class="anchor" href="#%E5%AE%9A%E4%B9%89%E6%8C%87%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%9C%A8%E8%A7%84%E5%AE%9A%E6%97%B6%E9%97%B4%E5%86%85%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E5%8F%AA%E8%83%BD%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E5%A6%82%E6%9E%9C%E5%9C%A8%E8%A7%84%E5%AE%9A%E6%97%B6%E9%97%B4%E5%86%85%E5%8F%88%E8%A7%A6%E5%8F%91%E4%BA%86%E8%AF%A5%E4%BA%8B%E4%BB%B6%E5%88%99%E4%BC%9A%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B%E7%AE%97%E8%A7%84%E5%AE%9A%E6%97%B6%E9%97%B4%E7%AE%80%E8%80%8C%E8%A8%80%E4%B9%8B%E5%B0%B1%E6%98%AF%E5%BB%B6%E6%97%B6%E6%89%A7%E8%A1%8C">§</a></h3>
<h3 id="%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">应用场景<a class="anchor" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">§</a></h3>
<p>两个条件：</p>
<ol>
<li>如果客户连续的操作会导致频繁的事件回调（可能引起页面卡顿）</li>
<li>客户只关心“最后一次”操作（也可以理解为停止连续操作后）所返回的结果。</li>
</ol>
<p>例如：</p>
<ul>
<li>输入搜索联想，用户在不断输入值时，用防抖来节约请求资源。</li>
<li>按钮点击： 收藏、点赞、爱心等。</li>
</ul>
<h3 id="%E5%8E%9F%E7%90%86">原理<a class="anchor" href="#%E5%8E%9F%E7%90%86">§</a></h3>
<p>通过定时器将回调函数进行延时，如果在规定时间内继续回调，发现存在之前的定时器，则将该定时器清除，并重新设置定时器。这里有个细节，就是后面所有的回调函数都要能访问到之前设置的定时器，这时就需要用到闭包（详情见后边）</p>
<p>防抖分为两种：</p>
<ul>
<li>非立即执行：事件触发-&gt;延时-&gt;执行回调函数；如果在延时中，继续触发事件，则会重新进行延时，在延时结束后执行回调函数。常见的例子：input搜索框，客户输完过一会就会自动搜索。</li>
<li>立即执行：事件触发-&gt;执行回调函数-&gt;延时；如果在延时中，继续触发事件，则会重新进行延时。在延时结束后，并不会执行回调函数。常见的例子：对于按钮防点击，例如点赞，爱心，收藏等立即有反馈的按钮。</li>
</ul>
<p>实现思路：</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// 非立即执行</span>
<span class="token comment">// 回调函数</span>
<span class="token keyword">function</span> <span class="token function">showLog</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Log: '</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 包装函数
* 1.保存定时器标识
* 2.返回闭包函数：
*   1）对定时器的判断清除；
*   2）一般还需要保存函数的参数（一般就是事件返回的对象）和上下文（定时器存在this隐式丢失：详情见【我不知*      道的js 上】）
* 不建议通过定义一个全局变量来替闭包保存定时器标识。
*/</span>
<span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fun<span class="token punctuation">,</span> delay<span class="token operator">=</span><span class="token number">500</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// let timer = null 保存定时器</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> _args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token comment">// 这里对定时器的设置有两种方法，第一种就是将定时器保存在函数（函数也是对象）的属性上</span>
        <span class="token comment">// 这种写法很简便，但不常用</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span><span class="token property-access">timer</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fun<span class="token punctuation">.</span><span class="token property-access">timer</span> <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fun<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>that<span class="token punctuation">,</span> _args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 另一种写法是比较常见的</span>
        <span class="token comment">// if (timer) clearTimeout(timer); 相比上面的方法，这里多一个判断</span>
        <span class="token comment">// timer = setTimeout(function() {</span>
        <span class="token comment">//     fun.call(that, _args);</span>
        <span class="token comment">// }, delay);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 接着用变量保存debounce返回的带有延时功能的函数</span>
<span class="token keyword">let</span> debounceShowLog <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>showLog<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 最后添加事件监听，回调debounceShowLog并传入事件返回的对象</span>
<span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'debounce'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
input<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debounceShowLog</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 立即执行</span>
<span class="token comment">// 定时器中不再包含回调函数，而是在回调函数执行后，仅起到延时和重置定时器标识的作用</span>
<span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fun<span class="token punctuation">,</span> delay<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> immediate<span class="token operator">=</span><span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span> <span class="token comment">// 保存定时器</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> _args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不管是否立即执行都需要先清空定时器</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> fun<span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>that<span class="token punctuation">,</span> _args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果定时器不存在，则说明延时已过，可以立即执行函数</span>
            timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不管上一个延时是否完成，都需要重置定时器</span>
                timer <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span> <span class="token comment">// 到时间后，定时器自动设为null，不仅方便判断定时器状态还能避免内存泄漏</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果是非立即执行，则重新设定定时器，并将回调函数放入其中</span>
            timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fun<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>that<span class="token punctuation">,</span> _args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>